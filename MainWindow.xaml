<Window x:Class="AI生成AI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AI生成AI"
        xmlns:avalon="http://icsharpcode.net/sharpdevelop/avalonedit"
        mc:Ignorable="d"
        Title="OLMo Manager" Height="750" Width="1200"
        WindowStartupLocation="CenterScreen">
    <Window.Resources>
        <DataTemplate x:Key="ClosableTabItemHeader">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{Binding}" Margin="5,0" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                <Button Grid.Column="1" Content="✕" Width="20" Height="20" Margin="0" Padding="0" FontSize="10"
                        Background="Transparent" BorderThickness="0" Click="CloseTabButton_Click"
                        Tag="{Binding RelativeSource={RelativeSource AncestorType=TabItem}}" ToolTip="关闭标签页">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Foreground" Value="DarkGray"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Foreground" Value="Red"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </Grid>
        </DataTemplate>
        <local:BoolToFontWeightConverter x:Key="BoolToFontWeightConverter"/>
        <local:ResolvedStatusConverter x:Key="ResolvedStatusConverter"/>

        <!-- 错误列表链接样式 -->
        <Style x:Key="LinkTextStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="Blue"/>
            <Setter Property="TextDecorations" Value="Underline"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="2"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="DarkBlue"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="220"/>
        </Grid.RowDefinitions>

        <!-- 顶部按钮区域 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5" Background="#FFEEE9E9">
            <Button x:Name="btnImport" Content="导入" Width="80" Height="30" Margin="5" Click="btnImport_Click"/>
            <Button x:Name="btnPack" Content="打包SDK" Width="80" Height="30" Margin="5" Click="btnPack_Click"/>
            <Button x:Name="btnRun" Content="运行" Width="80" Height="30" Margin="5" Click="btnRun_Click"/>
            <Button x:Name="btnTest" Content="测试对话" Width="80" Height="30" Margin="5" Click="btnTest_Click"/>
            <Button x:Name="btnStructureTree" Content="结构树生成" Width="100" Height="30" Margin="5" Click="btnStructureTree_Click"/>
            <!-- 添加结构树检测按钮 -->
            <Button x:Name="btnStructureCheck" Content="结构树检测" Width="100" Height="30" Margin="5" Click="btnStructureCheck_Click"/>
        </StackPanel>

        <!-- 导入控制区域 -->
        <Border Grid.Row="1" x:Name="importPanel" Visibility="Collapsed" BorderThickness="1" BorderBrush="Gray" Padding="10" Margin="5">
            <StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                    <TextBlock Text="导入类型:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <RadioButton x:Name="rbImportZip" Content="ZIP压缩包" GroupName="ImportType" IsChecked="True" Margin="0,0,20,0"/>
                    <RadioButton x:Name="rbImportFolder" Content="文件夹" GroupName="ImportType" Margin="0,0,20,0"/>
                    <RadioButton x:Name="rbImportFile" Content="文件" GroupName="ImportType"/>
                </StackPanel>

                <!-- ZIP导入部分 -->
                <StackPanel x:Name="zipImportPanel">
                    <StackPanel Orientation="Horizontal">
                        <TextBox x:Name="txtZipPath" Width="300" Margin="5"/>
                        <Button Content="选择ZIP" Width="80" Margin="5" Click="BrowseZip_Click"/>
                        <TextBox x:Name="txtExtractPath" Width="300" Margin="5"/>
                        <Button Content="选择目录" Width="80" Margin="5" Click="BrowseFolder_Click"/>
                        <Button Content="解压" Width="80" Margin="5" Click="Extract_Click"/>
                    </StackPanel>
                </StackPanel>

                <!-- 文件夹导入部分 -->
                <StackPanel x:Name="folderImportPanel" Visibility="Collapsed">
                    <StackPanel Orientation="Horizontal">
                        <TextBox x:Name="txtFolderPath" Width="300" Margin="5"/>
                        <Button Content="选择文件夹" Width="80" Margin="5" Click="BrowseFolderImport_Click"/>
                        <Button Content="导入项目" Width="80" Margin="5" Click="ImportFolder_Click"/>
                    </StackPanel>
                </StackPanel>

                <!-- 文件导入部分 -->
                <StackPanel x:Name="fileImportPanel" Visibility="Collapsed">
                    <StackPanel Orientation="Horizontal">
                        <TextBox x:Name="txtFilePath" Width="300" Margin="5"/>
                        <Button Content="选择文件" Width="80" Margin="5" Click="BrowseFileImport_Click"/>
                        <Button Content="导入文件" Width="80" Margin="5" Click="ImportFile_Click"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- 结构树生成面板 -->
        <Border Grid.Row="1" x:Name="structureTreePanel" Visibility="Collapsed" BorderThickness="1" BorderBrush="Gray" Padding="10" Margin="5">
            <StackPanel>
                <TextBlock Text="模型结构要求:" Margin="0,0,0,5"/>
                <TextBox x:Name="txtStructureRequirement" MinHeight="60" TextWrapping="Wrap" AcceptsReturn="True"
                         VerticalScrollBarVisibility="Auto" FontFamily="Consolas"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                    <Button x:Name="btnGenerateStructure" Content="生成结构树" Width="100" Margin="5" Click="btnGenerateStructure_Click"/>
                    <Button x:Name="btnCancelStructure" Content="取消" Width="80" Margin="5" Click="btnCancelStructure_Click"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- 主内容区域 -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧文件树 -->
            <TreeView x:Name="fileTreeView" Grid.Column="0" Margin="5" SelectedItemChanged="FileTreeView_SelectedItemChanged">
                <TreeView.ItemContainerStyle>
                    <Style TargetType="TreeViewItem">
                        <Setter Property="IsExpanded" Value="True"/>
                    </Style>
                </TreeView.ItemContainerStyle>
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                        <TextBlock Text="{Binding DisplayName}" 
                                   FontWeight="{Binding IsDirectory, Converter={StaticResource BoolToFontWeightConverter}}"
                                   VerticalAlignment="Center"/>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
                <TreeView.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="新建文件" Click="NewFile_Click"/>
                        <MenuItem Header="新建文件夹" Click="NewFolder_Click"/>
                        <Separator/>
                        <MenuItem Header="重命名" Click="RenameItem_Click"/>
                        <MenuItem Header="删除" Click="DeleteItem_Click"/>
                    </ContextMenu>
                </TreeView.ContextMenu>
            </TreeView>

            <!-- 右侧卡片区域 -->
            <TabControl x:Name="tabControl" Grid.Column="1" Margin="5">
                <TabControl.ItemContainerStyle>
                    <Style TargetType="TabItem">
                        <Setter Property="HeaderTemplate" Value="{StaticResource ClosableTabItemHeader}"/>
                        <Setter Property="Header" Value="{Binding RelativeSource={RelativeSource Self}, Path=Tag}"/>
                    </Style>
                </TabControl.ItemContainerStyle>
            </TabControl>
        </Grid>

        <!-- 底部标签区域 -->
        <TabControl x:Name="tabControlBottom" Grid.Row="4" Margin="5">
            <TabItem Header="控制台">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBox x:Name="txtConsole" IsReadOnly="True" VerticalScrollBarVisibility="Auto" 
                             TextWrapping="Wrap" FontFamily="Consolas"/>
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="txtCommand" Grid.Column="0" FontFamily="Consolas" KeyDown="txtCommand_KeyDown"/>
                        <Button x:Name="btnExecute" Grid.Column="1" Content="执行" Width="60" Margin="5,0" Click="btnExecute_Click"/>
                    </Grid>
                </Grid>
            </TabItem>
            <TabItem Header="日志">
                <TextBox x:Name="txtLog" IsReadOnly="True" VerticalScrollBarVisibility="Auto" 
                         TextWrapping="Wrap" FontFamily="Consolas"/>
            </TabItem>
            <TabItem Header="错误列表">
                <ListView x:Name="lstErrors" ItemsSource="{Binding Errors}">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="行号" Width="60" DisplayMemberBinding="{Binding Line}"/>
                            <GridViewColumn Header="列号" Width="60" DisplayMemberBinding="{Binding Column}"/>
                            <GridViewColumn Header="消息" Width="300" DisplayMemberBinding="{Binding Message}"/>
                            <GridViewColumn Header="文件" Width="200" DisplayMemberBinding="{Binding File}"/>
                            <GridViewColumn Header="解决方案" Width="200" DisplayMemberBinding="{Binding Solution}"/>
                            <GridViewColumn Header="操作" Width="100">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="AI智能解决" Style="{StaticResource LinkTextStyle}" 
                                                   MouseLeftButtonDown="BtnAIFix_Click" Tag="{Binding}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Header="状态" Width="80">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding IsResolved, Converter={StaticResource ResolvedStatusConverter}}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>
            </TabItem>
            <TabItem Header="AI聊天" x:Name="aiChatTab">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <ListBox x:Name="lstChat" FontFamily="Consolas" Background="#FFF0F0F0"
                             ScrollViewer.VerticalScrollBarVisibility="Auto">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" TextWrapping="Wrap" Margin="2"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <Grid Grid.Row="1" Margin="0,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="txtChatInput" Grid.Column="0" AcceptsReturn="True" TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto" MinHeight="60" MaxHeight="120" KeyDown="txtChatInput_KeyDown"/>
                        <Button x:Name="btnSend" Grid.Column="1" Content="发送" Width="60" Height="60" Margin="5,0" Click="btnSend_Click"/>
                    </Grid>
                </Grid>
            </TabItem>
            <TabItem Header="训练" x:Name="trainingTab">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBox x:Name="txtTrainingLog" IsReadOnly="True" VerticalScrollBarVisibility="Auto"
                             TextWrapping="Wrap" FontFamily="Consolas"/>
                    <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="5">
                        <Button x:Name="btnStartTraining" Content="开始训练" Width="100" Height="30" Margin="5" Click="btnStartTraining_Click"/>
                        <Button x:Name="btnStopTraining" Content="停止训练" Width="100" Height="30" Margin="5" Click="btnStopTraining_Click" IsEnabled="False"/>
                        <Button x:Name="btnGenerateData" Content="生成训练数据" Width="120" Height="30" Margin="5" Click="btnGenerateData_Click"/>
                        <Button x:Name="btnSaveTrainingConfig" Content="保存配置" Width="100" Height="30" Margin="5" Click="btnSaveTrainingConfig_Click"/>
                    </StackPanel>
                </Grid>
            </TabItem>
            <TabItem Header="权重设计" x:Name="weightDesignTab">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <GroupBox Grid.Row="0" Header="权重初始化策略" Margin="5">
                            <StackPanel>
                                <ComboBox x:Name="cmbInitStrategy" SelectedIndex="0" Margin="0,5">
                                    <ComboBoxItem>使用DeepSeek作为教师模型</ComboBoxItem>
                                    <ComboBoxItem>随机初始化</ComboBoxItem>
                                    <ComboBoxItem>预训练权重</ComboBoxItem>
                                </ComboBox>
                                <CheckBox x:Name="chkKnowledgeDistillation" Content="使用知识蒸馏" Margin="0,5" IsChecked="True"/>
                                <TextBlock Text="API密钥:" Margin="0,5,0,0"/>
                                <TextBox x:Name="txtTeacherModelApiKey" Width="300" Text="sk-e4d234ec0ce5425cb84a54bd227f32f7"/>
                            </StackPanel>
                        </GroupBox>
                        <GroupBox Grid.Row="1" Header="自定义权重设置" Margin="5">
                            <StackPanel>
                                <TextBlock Text="权重想法描述:" Margin="0,5"/>
                                <TextBox x:Name="txtWeightIdea" MinHeight="60" TextWrapping="Wrap" AcceptsReturn="True"
                                         FontFamily="Consolas" VerticalScrollBarVisibility="Auto"/>

                                <TextBlock Text="层权重配置 (JSON格式):" Margin="0,5"/>
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="120">
                                    <TextBox x:Name="txtLayerWeights" MinHeight="80" TextWrapping="Wrap" AcceptsReturn="True"
                                             FontFamily="Consolas" VerticalScrollBarVisibility="Auto"/>
                                </ScrollViewer>
                            </StackPanel>
                        </GroupBox>
                        <GroupBox Grid.Row="2" Header="权重预览" Margin="5">
                            <DataGrid x:Name="dgWeights" AutoGenerateColumns="True" IsReadOnly="True"
                                      CanUserAddRows="False" CanUserDeleteRows="False"/>
                        </GroupBox>
                        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center" Margin="5">
                            <Button x:Name="btnApplyWeights" Content="应用权重" Width="100" Height="30" Margin="5" Click="btnApplyWeights_Click"/>
                            <Button x:Name="btnExportWeights" Content="导出权重" Width="100" Height="30" Margin="5" Click="btnExportWeights_Click"/>
                            <Button x:Name="btnOptimizeWeights" Content="AI优化权重" Width="100" Height="30" Margin="5" Click="btnOptimizeWeights_Click"/>
                            <Button x:Name="btnGenerateWeights" Content="AI生成权重" Width="100" Height="30" Margin="5" Click="btnGenerateWeights_Click"/>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </Grid>
</Window>